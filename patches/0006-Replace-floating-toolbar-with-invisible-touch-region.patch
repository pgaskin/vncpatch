From 4173338ec36101f9da1997d1cacce3ca1d920c10 Mon Sep 17 00:00:00 2001
From: Patrick Gaskin <patrick@pgaskin.net>
Date: Sat, 14 Dec 2024 14:38:51 -0500
Subject: [PATCH 6/7] Replace floating toolbar with invisible touch regions


diff --git a/res/layout/activity_desktop.xml b/res/layout/activity_desktop.xml
index 8087a93..be8ad89 100644
--- a/res/layout/activity_desktop.xml
+++ b/res/layout/activity_desktop.xml
@@ -5,6 +5,17 @@
         <com.realvnc.viewer.android.ui.input.CapturingEditText android:id="@id/hidden_input_view" android:focusable="true" android:layout_width="1.0dip" android:layout_height="1.0dip" android:text="" android:singleLine="false" android:imeOptions="actionNone|flagNoExtractUi" />
         <com.realvnc.viewer.android.ui.input.InterceptingRelativeLayout android:orientation="vertical" android:id="@id/intercepting_relative_layout" android:layout_width="fill_parent" android:layout_height="fill_parent" android:splitMotionEvents="true">
             <com.realvnc.viewer.android.ui.scroll.DesktopView android:orientation="vertical" android:id="@id/desktop_view" android:background="@color/background_grey" android:focusable="false" android:visibility="invisible" android:layout_width="fill_parent" android:layout_height="fill_parent" />
+            <LinearLayout android:orientation="vertical" android:layout_width="fill_parent" android:layout_height="fill_parent">
+                <LinearLayout android:orientation="horizontal" android:layout_width="fill_parent" android:layout_height="0dip" android:layout_weight="2">
+                    <View android:id="@id/menu_disconnect" android:layout_height="fill_parent" android:layout_weight="1" android:layout_width="0dp" android:background="#00000000" />
+                    <View android:id="@id/menu_information" android:layout_height="fill_parent" android:layout_weight="4" android:layout_width="0dp" android:background="#00000000" />
+                </LinearLayout>
+                <View android:layout_width="fill_parent" android:layout_height="0dp" android:layout_weight="17" />
+                <LinearLayout android:orientation="horizontal" android:layout_width="fill_parent" android:layout_height="0dip" android:layout_weight="3">
+                    <View android:id="@id/menu_keyboard" android:layout_height="fill_parent" android:layout_weight="4" android:layout_width="0dp" android:background="#00000000" />
+                    <View android:id="@id/menu_mouse" android:layout_height="fill_parent" android:layout_weight="1" android:layout_width="0dp" android:background="#00000000" />
+                </LinearLayout>
+            </LinearLayout>
             <com.realvnc.viewer.android.ui.CursorView android:id="@id/cursor_view" android:visibility="gone" android:layout_width="fill_parent" android:layout_height="fill_parent" />
             <com.realvnc.viewer.android.ui.ZoomView android:id="@id/zoom_view" android:visibility="gone" android:layout_width="wrap_content" android:layout_height="wrap_content" android:layout_alignParentBottom="true" android:layout_centerHorizontal="true" />
             <LinearLayout android:orientation="vertical" android:id="@id/overlay_parent" android:layout_width="fill_parent" android:layout_height="wrap_content" android:layout_alignParentBottom="true">
diff --git a/smali/com/realvnc/viewer/android/app/DesktopActivity.smali b/smali/com/realvnc/viewer/android/app/DesktopActivity.smali
index 792209f..1c829dc 100644
--- a/smali/com/realvnc/viewer/android/app/DesktopActivity.smali
+++ b/smali/com/realvnc/viewer/android/app/DesktopActivity.smali
@@ -4117,9 +4117,99 @@
 
     invoke-virtual {v0, v1}, Landroid/view/View;->setOnClickListener(Landroid/view/View$OnClickListener;)V
 
+    invoke-direct {v8}, Lcom/realvnc/viewer/android/app/DesktopActivity;->setupExperimentalInvisibleActionButtons()V
+
     return-void
 .end method
 
+.method private final setupExperimentalInvisibleActionButtons()V
+    .locals 3
+
+    const v0, 0x7f09021a  # @id/menu_keyboard
+    const v1, 0
+    invoke-static {p0, v0, v1}, Lcom/realvnc/viewer/android/app/InvisibleDesktopButtonTrampoline;->use(Lcom/realvnc/viewer/android/app/DesktopActivity;II)V
+
+    const v0, 0x7f09021b  # @id/menu_mouse
+    const v1, 1
+    invoke-static {p0, v0, v1}, Lcom/realvnc/viewer/android/app/InvisibleDesktopButtonTrampoline;->use(Lcom/realvnc/viewer/android/app/DesktopActivity;II)V
+
+    const v0, 0x7f090219  # @id/menu_information
+    const v1, 2
+    invoke-static {p0, v0, v1}, Lcom/realvnc/viewer/android/app/InvisibleDesktopButtonTrampoline;->use(Lcom/realvnc/viewer/android/app/DesktopActivity;II)V
+
+    const v0, 0x7f090211  # @id/menu_disconnect
+    const v1, 3
+    invoke-static {p0, v0, v1}, Lcom/realvnc/viewer/android/app/InvisibleDesktopButtonTrampoline;->use(Lcom/realvnc/viewer/android/app/DesktopActivity;II)V
+
+    const v0, 0x7f09013c  # @id/fabTlbrGroup
+    const v1, 8  # GONE
+    invoke-virtual {p0, v0}, Landroidx/appcompat/app/AppCompatActivity;->findViewById(I)Landroid/view/View;
+    move-result-object v0
+    invoke-virtual {v0, v1}, Landroid/view/View;->setVisibility(I)V
+
+    const v0, 0x7f09013b  # @id/fabCoachTutorial
+    const v1, 8  # GONE
+    invoke-virtual {p0, v0}, Landroidx/appcompat/app/AppCompatActivity;->findViewById(I)Landroid/view/View;
+    move-result-object v0
+    invoke-virtual {v0, v1}, Landroid/view/View;->setVisibility(I)V
+
+    return-void
+.end method
+
+.method public final handleInvisibleDesktopButton(I)V
+    .locals 4
+
+    # see Lcom/realvnc/viewer/android/app/DesktopActivity;->onOptionsItemSelected
+
+    # clear extension keyboard keys
+    iget-object v1, p0, Lcom/realvnc/viewer/android/app/DesktopActivity;->K0:Lx2/l0;
+    const/4 v2, 0x1
+    invoke-virtual {v1, v2}, Lx2/l0;->c(Z)V
+
+    packed-switch p1, :actions
+    return-void
+
+    :keyboard
+    iget-object p1, p0, Lcom/realvnc/viewer/android/app/DesktopActivity;->X:Lw2/e;
+    invoke-virtual {p1}, Lw2/e;->N()Z
+    move-result p1
+    if-eqz p1, :cond_1
+    invoke-direct {p0}, Lcom/realvnc/viewer/android/app/DesktopActivity;->t1()V
+    return-void
+    :cond_1
+    iget-object p1, p0, Lcom/realvnc/viewer/android/app/DesktopActivity;->n0:Ly2/d;
+    invoke-virtual {p1}, Ly2/d;->F()V
+    return-void
+
+    :mouse
+    iget-object p1, p0, Lcom/realvnc/viewer/android/app/DesktopActivity;->X:Lw2/e;
+    invoke-virtual {p1}, Lw2/e;->N()Z
+    move-result p1
+    if-eqz p1, :cond_2
+    invoke-direct {p0}, Lcom/realvnc/viewer/android/app/DesktopActivity;->t1()V
+    return-void
+    :cond_2
+    iget-object p1, p0, Lcom/realvnc/viewer/android/app/DesktopActivity;->n0:Ly2/d;
+    invoke-virtual {p1}, Ly2/d;->G()V
+    return-void
+
+    :information
+    invoke-direct {p0}, Lcom/realvnc/viewer/android/app/DesktopActivity;->p1()V
+    return-void
+
+    :disconnect
+    invoke-direct {p0}, Lcom/realvnc/viewer/android/app/DesktopActivity;->M0()V
+    return-void
+
+    :actions
+    .packed-switch 0x0
+        :keyboard
+        :mouse
+        :information
+        :disconnect
+    .end packed-switch
+.end method
+
 .method public final onCreateOptionsMenu(Landroid/view/Menu;)Z
     .locals 4
 
diff --git a/smali/com/realvnc/viewer/android/app/InvisibleDesktopButtonTrampoline.smali b/smali/com/realvnc/viewer/android/app/InvisibleDesktopButtonTrampoline.smali
new file mode 100644
index 0000000..bd84ca7
--- /dev/null
+++ b/smali/com/realvnc/viewer/android/app/InvisibleDesktopButtonTrampoline.smali
@@ -0,0 +1,34 @@
+.class final Lcom/realvnc/viewer/android/app/InvisibleDesktopButtonTrampoline;
+.super Ljava/lang/Object;
+.source "SourceFile"
+
+.implements Landroid/view/View$OnClickListener;
+
+.field final activity:Lcom/realvnc/viewer/android/app/DesktopActivity;
+.field final action:I
+
+.method public constructor <init>(Lcom/realvnc/viewer/android/app/DesktopActivity;I)V
+    .locals 0
+    iput-object p1, p0, Lcom/realvnc/viewer/android/app/InvisibleDesktopButtonTrampoline;->activity:Lcom/realvnc/viewer/android/app/DesktopActivity;
+    iput p2, p0, Lcom/realvnc/viewer/android/app/InvisibleDesktopButtonTrampoline;->action:I
+    invoke-direct {p0}, Ljava/lang/Object;-><init>()V
+    return-void
+.end method
+
+.method public final onClick(Landroid/view/View;)V
+    .locals 0
+    iget p1, p0, Lcom/realvnc/viewer/android/app/InvisibleDesktopButtonTrampoline;->action:I
+    iget-object p0, p0, Lcom/realvnc/viewer/android/app/InvisibleDesktopButtonTrampoline;->activity:Lcom/realvnc/viewer/android/app/DesktopActivity;
+    invoke-virtual {p0, p1}, Lcom/realvnc/viewer/android/app/DesktopActivity;->handleInvisibleDesktopButton(I)V
+    return-void
+.end method
+
+.method public final static use(Lcom/realvnc/viewer/android/app/DesktopActivity;II)V
+    .locals 1
+    invoke-virtual {p0, p1}, Landroidx/appcompat/app/AppCompatActivity;->findViewById(I)Landroid/view/View;
+    move-result-object p1
+    new-instance v0, Lcom/realvnc/viewer/android/app/InvisibleDesktopButtonTrampoline;
+    invoke-direct {v0, p0, p2}, Lcom/realvnc/viewer/android/app/InvisibleDesktopButtonTrampoline;-><init>(Lcom/realvnc/viewer/android/app/DesktopActivity;I)V
+    invoke-virtual {p1, v0}, Landroid/view/View;->setOnClickListener(Landroid/view/View$OnClickListener;)V
+    return-void
+.end method
